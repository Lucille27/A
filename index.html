<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù†Ø©</title>
<style>
  /* 1. Ø¯Ø¹Ù… Ø§Ù„ØªØ¬Ø§ÙˆØ¨ (Media Query) */
  body { 
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
    padding: 20px; 
    background:#f5f5f5; 
    direction: rtl; 
    text-align: right; 
    transition: background-color 0.5s;
  }
  
  #questionBox { border: 1px solid #ccc; padding: 20px; border-radius: 8px; margin-bottom: 20px; background:white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  
  #timer { font-size: 24px; font-weight: bold; margin-bottom: 10px; transition: color 0.5s; } 
  #lowTimeWarning { color: #FF9800; font-weight: bold; margin-top: 5px; display: none; }
  
  #progressBar { width: 100%; background: #ddd; border-radius: 10px; margin-bottom: 20px; }
  #progressTime { height: 20px; background: #4CAF50; border-radius: 10px; transition: background-color 0.5s; } 
  
  input[type="text"], input[type="number"], textarea { 
    padding: 8px 10px; 
    font-size: 16px; 
    width: 250px;
    border: 1px solid #ccc;
    border-radius: 4px;
    transition: border-color 0.3s;
    text-align: right; 
    margin-bottom: 10px;
    box-sizing: border-box; 
  }
  textarea {
      width: 100%;
      min-height: 80px;
      resize: vertical;
  }
  input[type="text"]:focus, input[type="number"]:focus, textarea:focus {
    border-color: #007bff; 
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
  }

  /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø²Ø± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
  .actionBtn {
    padding: 12px 25px;
    font-size: 18px;
    background-color: #007bff; 
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-top:10px;
    transition: background-color 0.3s, transform 0.1s;
    width: 100%; 
    max-width: 300px;
    display: block; 
  }
  .actionBtn:hover {
    background-color: #0056b3;
  }
  /* Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ Ø¨ØªÙ†Ø³ÙŠÙ‚ Ù…Ù…ÙŠØ² */
  #startExamBtn {
      background-color: #4CAF50; 
      max-width: 400px;
      margin: 20px auto;
  }
  #startExamBtn:hover {
      background-color: #45a049;
  }
  
  #cheatingWarning { color: white; background: #FF0000; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: none; } 

  label {
    display: flex; 
    align-items: center; 
    margin: 10px 0;
    cursor: pointer;
    padding: 12px;
    border-radius: 6px;
    transition: background-color 0.2s, box-shadow 0.2s;
  }
  label:hover {
    background: #e9e9e9;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  }
  input[type="radio"] {
    margin-left: 10px; 
    transform: scale(1.3); 
    order: 2; 
  }

  #resultBox {
    font-size: 20px;
    padding: 30px;
    border: 2px solid #007bff;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    background:white;
    border-radius:8px;
    text-align: center;
    display:none; 
  }

  #detailsTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 14px;
      text-align: right;
  }
  #detailsTable th, #detailsTable td {
      border: 1px solid #ddd;
      padding: 8px;
  }
  #detailsTable th {
      background-color: #f2f2f2;
      color: #333;
      text-align: right;
  }
  .correct-answer { background-color: #e6ffe6; }
  .wrong-answer { background-color: #ffe6e6; }
  .cheating-flagged { background-color: #ffcccc; border-left: 5px solid red; } 
  
  /* Media Query Ù„Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ø°ÙƒÙŠØ© */
  @media (max-width: 600px) {
      body { padding: 10px; }
      input[type="text"], input[type="number"], textarea { width: 100%; } 
      #detailsTable, #detailsTable tbody, #detailsTable tr, #detailsTable td {
          display: block;
          width: 100%;
      }
      #detailsTable thead { display: none; }
      #detailsTable tr { margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
      #detailsTable td { 
          text-align: right; 
          padding-left: 50%;
          position: relative;
          border: none;
      }
      #detailsTable td:before { 
          content: attr(data-label); 
          position: absolute;
          right: 6px;
          width: 45%;
          padding-left: 10px;
          font-weight: bold;
          text-align: right;
      }
  }
</style>
</head>
<body>
<audio id="lowTimeSound" src="path/to/countdown_beep.mp3" preload="auto"></audio>
<audio id="correctAnswerSound" src="path/to/correct_chime.mp3" preload="auto"></audio>
<audio id="wrongAnswerSound" src="path/to/wrong_buzz.mp3" preload="auto"></audio>

<h2>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø­Ø³Ù‘Ù†</h2>

<div id="studentInfo">
  Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: <input type="text" id="studentName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
</div>
<div id="studentIDInfo">
  Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ø§Ù„Ø¨: <input type="text" id="studentID" placeholder="Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ø§Ù„Ø¨">
</div>
<div>
  Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (%): <input type="number" id="passPercentage" value="50" min="1" max="100">
</div>
<br>

<button id="startExamBtn" class="actionBtn" onclick="startExam()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†</button>


<div id="examElements" style="display:none;">
    <div id="cheatingWarning">âš ï¸ ØªÙ… Ø±ØµØ¯ Ù…Ø­Ø§ÙˆÙ„Ø© Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØµÙØ­Ø© Ø£Ùˆ ÙØªØ­ Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù…Ø·ÙˆØ±. Ø³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØºØ´!</div>
    <div id="progressBar"><div id="progressTime"></div></div>
    <div id="timer"></div>
    <div id="lowTimeWarning">âš ï¸ ØªØ¨Ù‚Ù‰ 5 Ø«ÙˆØ§Ù†Ù! Ø£Ø³Ø±Ø¹ ÙÙŠ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©.</div>
    <div id="questionBox"></div>
    <button id="submitBtn" class="actionBtn" onclick="submitExam()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
</div>
<div id="resultBox"></div>

<script>
// âš ï¸ ÙŠØ¬Ø¨ ØªØºÙŠÙŠØ± Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Web App Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ø¨Ø¹Ø¯ Ø§Ù„Ù†Ø´Ø±
const API_URL = "https://script.google.com/macros/s/AKfycbwoqZa50RfZlFKiZOrHI88poc8bB15UYn1SHU93auTQ78ckNrZi85h-G1REvIsKd5Q/exec";

let questions = [];
let currentIndex = 0;
let timeWorker; 
let remainingTime;
let studentAnswers = [];
let totalQuestionTime; 
let examStartTime = new Date(); 
let cheatingFlag = false; 
let questionsLoaded = false; 

const lowTimeSound = document.getElementById('lowTimeSound');
const correctAnswerSound = document.getElementById('correctAnswerSound');
const wrongAnswerSound = document.getElementById('wrongAnswerSound');

const examElements = document.getElementById('examElements');
const startExamButton = document.getElementById('startExamBtn');
const studentNameInput = document.getElementById('studentName');
const studentIDInput = document.getElementById('studentID');
const cheatingWarningElement = document.getElementById('cheatingWarning');


// --- 1. Ø¢Ù„ÙŠØ© Ù…Ù†Ø¹ Ø§Ù„ØºØ´ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© ---
document.addEventListener('contextmenu', event => event.preventDefault());

let cheatingAttempts = 0;

function handleCheatingAttempt(reason) {
    if (cheatingFlag || examElements.style.display === 'none') return; 

    cheatingAttempts++;
    cheatingWarningElement.style.display = 'block';
    console.warn(`Cheating attempt detected: ${reason} (Attempt: ${cheatingAttempts})`);
    
    if (cheatingAttempts >= 2) {
        cheatingFlag = true;
        if (timeWorker) timeWorker.postMessage('stop');
        sendResults(); 
        alert("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØºØ´.");
    }
}

window.onblur = () => {
    if(currentIndex < questions.length) {
        handleCheatingAttempt("Window Blur");
    }
};

document.addEventListener('keydown', (e) => {
    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
        handleCheatingAttempt("Developer Tools Attempt");
        e.preventDefault();
    }
});


document.addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && document.getElementById('submitBtn').style.display !== 'none') {
        submitExam();
    }
});

// --- 2. Ø¥Ø¹Ø¯Ø§Ø¯ Web Worker Ù„Ù„Ù…Ø¤Ù‚Øª ---
const workerScript = `
    let timerInterval;
    let time = 0;
    
    self.onmessage = function(e) {
        if (e.data.command === 'start') {
            time = e.data.initialTime;
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                time--;
                self.postMessage(time);
                if (time <= 0) {
                    clearInterval(timerInterval);
                    self.postMessage('timeUp');
                }
            }, 1000);
        } else if (e.data === 'stop') {
            if (timerInterval) clearInterval(timerInterval);
        }
    };
`;
const workerBlob = new Blob([workerScript], { type: 'application/javascript' });
const workerURL = URL.createObjectURL(workerBlob);

// --- Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ù„ÙƒÙ† Ù„Ø§ ÙŠØªÙ… Ø§Ù„Ø¨Ø¯Ø¡ ---
fetch(API_URL + "?func=getQuestions")
  .then(res => res.json())
  .then(data => initTest(data))
  .catch(error => {
      console.error('Error fetching questions:', error);
      alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….');
  });

function initTest(data) {
  if(data.length === 0 || data.status === 'error'){ 
      alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø£Ùˆ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…!"); 
      return; 
  }
  
  questions = data.map(q => ({
      ...q,
      type: q.type || 'radio' 
  }));
  
  questionsLoaded = true;
  startExamButton.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†';
  startExamButton.disabled = false;
  
  if (!timeWorker) {
      timeWorker = new Worker(workerURL);
      timeWorker.onmessage = (e) => {
          if (e.data === 'timeUp') {
              recordAnswer(totalQuestionTime); 
              currentIndex++;
              updateOverallProgress();
              showQuestion(currentIndex);
          } else {
              remainingTime = e.data;
              document.getElementById("timer").textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remainingTime} Ø«Ø§Ù†ÙŠØ©`;
              
              if (remainingTime === 5) {
                  document.getElementById("lowTimeWarning").style.display = "block";
                  lowTimeSound.play().catch(e => console.log("Sound playback blocked:", e));
              } else if (remainingTime < 5) {
                  document.getElementById("lowTimeWarning").style.display = "block";
              } else {
                  document.getElementById("lowTimeWarning").style.display = "none";
              }
              
              updateTimeProgress(remainingTime, totalQuestionTime);
          }
      };
  }
}

/**
 * ğŸš¨ Ø¯Ø§Ù„Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù… ğŸš¨
 */
async function startExam() {
    const studentName = studentNameInput.value.trim();
    const studentID = studentIDInput.value.trim();

    if(studentName === "" || studentID === ""){ 
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆÙ…Ø¹Ø±ÙÙ‡ Ø£ÙˆÙ„Ø§Ù‹."); 
        return; 
    }
    
    if (!questionsLoaded || questions.length === 0) {
        alert("Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„Ù‡Ø§ Ø¨Ø¹Ø¯. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
        return;
    }
    
    // 1. Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØªØ­ÙˆÙŠÙ„ Ø²Ø± Ø§Ù„Ø¨Ø¯Ø¡ Ø¥Ù„Ù‰ Ø­Ø§Ù„Ø© "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚"
    studentNameInput.disabled = true;
    studentIDInput.disabled = true;
    startExamButton.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
    startExamButton.disabled = true;

    try {
        // 2. Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Apps Script
        const response = await fetch(`${API_URL}?func=validateIDOnly&studentID=${encodeURIComponent(studentID)}`);
        const msg = await response.json();

        // 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø¯
        if (msg.status === 'success') {
            
            startExamButton.style.display = 'none';
            examElements.style.display = 'block';
            examStartTime = new Date(); 
            showQuestion(currentIndex);
            
        } else {
            // Ø§Ù„ØªØ­Ù‚Ù‚ ÙØ´Ù„ (Ø®Ø·Ø£ 401 Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…)
            alert(`ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚: ${msg.message}`);
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø²Ø± Ù„Ù„ØªØ­Ø±ÙŠØ±
            studentNameInput.disabled = false;
            studentIDInput.disabled = false;
            startExamButton.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†';
            startExamButton.disabled = false;
        }

    } catch (error) {
        alert(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…: ØªØ¹Ø°Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø¹Ø±Ù. ${error.message}`);
        console.error('Validation fetch error:', error);
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªÙ…ÙƒÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„
        studentNameInput.disabled = false;
        studentIDInput.disabled = false;
        startExamButton.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¢Ù†';
        startExamButton.disabled = false;
    }
}


function showQuestion(index) {
  if (cheatingFlag) return; 
  if (index >= questions.length) { 
      if (timeWorker) timeWorker.postMessage('stop');
      sendResults(); 
      return; 
  }

  const q = questions[index];
  const box = document.getElementById("questionBox");
  let inputHTML = '';
  
  if (q.type === 'shortText') {
      inputHTML = `
        <label for="textAnswer">Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ù‡Ù†Ø§:</label>
        <textarea id="textAnswer" name="answer" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ"></textarea>
      `;
  } else {
      inputHTML = `
        <label><input type="radio" name="answer" value="${q.opt1}"> <span>${q.opt1}</span></label>
        <label><input type="radio" name="answer" value="${q.opt2}"> <span>${q.opt2}</span></label>
        <label><input type="radio" name="answer" value="${q.opt3}"> <span>${q.opt3}</span></label>
      `;
  }

  box.innerHTML = `
    <b>Ø§Ù„Ø³Ø¤Ø§Ù„ ${index + 1} (${q.type === 'shortText' ? 'Ù†ØµÙŠ Ù‚ØµÙŠØ±' : 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯'}):</b> ${q.question}<br><br>
    ${inputHTML}
  `;

  totalQuestionTime = parseInt(q.time); 
  remainingTime = totalQuestionTime;
  
  document.getElementById("lowTimeWarning").style.display = "none";
  document.getElementById("timer").textContent = `Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${remainingTime} Ø«Ø§Ù†ÙŠØ©`;

  timeWorker.postMessage({ command: 'start', initialTime: totalQuestionTime });

  updateTimeProgress(remainingTime, totalQuestionTime);
  updateOverallProgress();
}

function updateTimeProgress(current, total) {
    const timeRatio = current / total;
    const timeProgressElement = document.getElementById("progressTime");
    const timerElement = document.getElementById("timer");
    
    timeProgressElement.style.width = (timeRatio * 100) + "%";
    
    let color;
    if (timeRatio > 0.4) {
        color = '#4CAF50'; 
    } else if (timeRatio > 0.15) {
        color = '#FFC107'; 
    } else {
        color = '#F44336'; 
    }
    
    timeProgressElement.style.backgroundColor = color;
    timerElement.style.color = color;
}


function submitExam() {
  if (cheatingFlag) return; 
  
  if (timeWorker) timeWorker.postMessage('stop');
  
  const timeTaken = totalQuestionTime - remainingTime;
  recordAnswer(timeTaken);
  currentIndex++;
  updateOverallProgress();
  showQuestion(currentIndex);
}


function recordAnswer(timeTaken) {
  const q = questions[currentIndex];
  let answer;
  let isCorrect;
  
  if (q.type === 'shortText') {
      answer = document.getElementById('textAnswer') ? document.getElementById('textAnswer').value.trim() : "No Answer";
      isCorrect = (answer === q.correct); 
  } else {
      const selected = document.querySelector('input[name="answer"]:checked');
      answer = selected ? selected.value : "No Answer";
      isCorrect = answer === q.correct;
  }
  
  if(answer !== "No Answer"){
      if(isCorrect){
          correctAnswerSound.play().catch(e => console.log("Sound playback blocked:", e));
      } else {
          wrongAnswerSound.play().catch(e => console.log("Sound playback blocked:", e));
      }
  }

  studentAnswers.push({
    question: q.question,
    selected: answer,
    correct: q.correct,
    type: q.type, 
    timeTaken: timeTaken,
    answeredAt: new Date().toISOString()
  });
}

function updateOverallProgress() {
  const progressContainer = document.getElementById("progressBar");
  const percent = Math.round((currentIndex / questions.length) * 100);
  
  progressContainer.style.width = "100%"; 
  
  if(currentIndex >= questions.length) {
      progressContainer.style.display = "none";
  } else {
      document.getElementById("progressTime").style.width = percent + "%"; 
      progressContainer.style.display = "block";
  }
}

function sendResults() {
  const studentName = studentNameInput.value.trim();
  const studentID = studentIDInput.value.trim();
  const passPercentage = parseInt(document.getElementById("passPercentage").value) || 50; 
  const examEndTime = new Date();
  const totalExamDurationSeconds = Math.round((examEndTime - examStartTime) / 1000); 

  
  if(studentName === "" || studentID === ""){ 
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆÙ…Ø¹Ø±ÙÙ‡ Ù‚Ø¨Ù„ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬."); 
    return; 
  }
  
  examElements.style.display = "none";

  const box = document.getElementById("resultBox");
  box.style.display = "block";
  box.innerHTML = '<b style="color:#007bff;">Ø¬Ø§Ø±ÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø©... Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹.</b>'; 

  let correctCount = studentAnswers.filter(a => a.selected === a.correct).length;
  let total = questions.length;
  let wrongCount = total - correctCount;
  let percentage = Math.round((correctCount / total) * 100);
  
  const statusEmoji = (percentage >= passPercentage) ? "âœ…" : "âŒ";
  const statusText = (percentage >= passPercentage) ? "Ù†Ø§Ø¬Ø­" : "Ø±Ø§Ø³Ø¨";
  const statusColor = (percentage >= passPercentage) ? '#4caf50' : '#f44336';

  const result = {
    studentID: studentID,
    student: studentName,
    score: percentage,
    total: total,
    correct: correctCount,
    passPercentage: passPercentage,
    totalExamDuration: totalExamDurationSeconds,
    cheatingFlag: cheatingFlag, 
    details: studentAnswers
  };
  
  // *** Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… POST ***
  fetch(API_URL + "?func=submitResult", {
      method: 'POST',
      headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: 'result=' + encodeURIComponent(JSON.stringify(result)) 
  })
    .then(res => res.json())
    .then(msg => {
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø®Ø·Ø£ Apps Script (ØªØ­Ù‚Ù‚ Ù…Ø¹Ø±Ù Ø§Ù„Ø·Ø§Ù„Ø¨ØŒ ÙƒØ®Ø·ÙˆØ© Ø£Ù…Ø§Ù† Ø¥Ø¶Ø§ÙÙŠØ©)
        if (msg.status === 'error' && msg.code === 401) {
             box.innerHTML = `
                <h3 style="color:red;">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ âš ï¸</h3>
                <p style="font-size: 18px;">${msg.message}</p>
                <br>
                <button onclick="window.location.reload()" class="actionBtn" style="background: #f44336; margin: 0 auto; display: block;">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button>
              `;
              if (timeWorker) timeWorker.terminate();
              return; 
        }
      
        // Ø¨Ù†Ø§Ø¡ Ø¬Ø¯ÙˆÙ„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
        let detailsHTML = '<h3>ØªÙØ§ØµÙŠÙ„ Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨:</h3>';
        detailsHTML += '<table id="detailsTable"><thead><tr><th>#</th><th>Ø§Ù„Ø³Ø¤Ø§Ù„</th><th>Ù†ÙˆØ¹ Ø§Ù„Ø³Ø¤Ø§Ù„</th><th>Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th><th>Ø²Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø«)</th></tr></thead><tbody>';
        
        studentAnswers.forEach((a, i) => {
            const isCorrect = a.selected === a.correct;
            const rowClass = isCorrect ? 'correct-answer' : 'wrong-answer';
            detailsHTML += `
                <tr class="${rowClass}">
                    <td data-label="#">${i + 1}</td>
                    <td data-label="Ø§Ù„Ø³Ø¤Ø§Ù„">${a.question}</td>
                    <td data-label="Ø§Ù„Ù†ÙˆØ¹">${a.type === 'shortText' ? 'Ù†ØµÙŠ' : 'Ø§Ø®ØªÙŠØ§Ø±'}</td>
                    <td data-label="Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø·Ø§Ù„Ø¨">${a.selected}</td>
                    <td data-label="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©">${a.correct}</td>
                    <td data-label="Ø§Ù„Ù†ØªÙŠØ¬Ø©">${isCorrect ? 'ØµØ­ÙŠØ­Ø© âœ…' : 'Ø®Ø§Ø·Ø¦Ø© âŒ'}</td>
                    <td data-label="Ø²Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© (Ø«)">${a.timeTaken}</td>
                </tr>
            `;
        });
        detailsHTML += '</tbody></table>';

        // ØªØ­Ø¯ÙŠØ« ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†ØªÙŠØ¬Ø©
        box.innerHTML = `
          <h3>ğŸ‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ğŸ‰</h3>
          <b>Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}</b><br>
          <hr style="border-top: 1px solid #ddd; margin: 15px 0;">
          ${cheatingFlag ? '<p class="cheating-flagged" style="font-size:20px;">ğŸš© ØªÙ… ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© ØºØ´ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±!</p>' : ''}
          <p>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙƒÙ„ÙŠ: ${total}</p>
          <p style="color: green;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correctCount}</p>
          <p style="color: red;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø®Ø§Ø·Ø¦Ø©: ${wrongCount}</p>
          <p>Ù…Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒÙ„ÙŠØ©: ${totalExamDurationSeconds} Ø«Ø§Ù†ÙŠØ©</p>
          <br>
          <p style="font-size: 24px;">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©: <b>${percentage}%</b> (Ø§Ù„Ù†Ø¬Ø§Ø­: ${passPercentage}%)</p>
          <p style="font-size: 28px; font-weight: bold; color: ${statusColor};">
            Ø§Ù„Ø­Ø§Ù„Ø©: ${statusText} ${statusEmoji}
          </p>
          <br>
          <hr style="border-top: 1px solid #ddd; margin: 15px 0;">
          ${detailsHTML}
          <br>
          <small style="color:#666;">${msg.message || "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ù†Ø¬Ø§Ø­!"}</small>
        `;
    })
    .catch(error => {
      box.innerHTML = `
        <h3 style="color:red;">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âš ï¸</h3>
        <b>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬:</b> <br>
        <small>${error.message}. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ø§Ø¨Ø· Web App.</small>
      `;
      console.error('Error submitting results:', error);
    });
    
    if (timeWorker) timeWorker.terminate();
}
</script>

</body>
</html>
